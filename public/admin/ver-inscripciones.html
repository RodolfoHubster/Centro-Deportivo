<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ver Inscripciones - Admin</title>
  <link rel="stylesheet" href="../css/main.css">
</head>
<body>

  <div id="header-placeholder"></div>

  <main class="page-content">
    <h1>Inscripciones a Eventos</h1>
    <p>Lista completa de personas inscritas a los eventos deportivos.</p>

    <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Buscar:</label>
          <input type="text" id="buscarInscripcion" placeholder="Nombre, matrícula, correo..." 
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Evento:</label>
          <select id="filtroEvento" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <option value="">Todos los eventos</option>
          </select>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Género:</label>
          <select id="filtroGenero" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <option value="">Todos</option>
            <option value="Hombre">Hombre</option>
            <option value="Mujer">Mujer</option>
            <option value="Prefiero no decirlo">Prefiero no decirlo</option>
          </select>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Tipo:</label>
          <select id="filtroTipo" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <option value="">Todos</option>
            <option value="Estudiante">Estudiante</option>
            <option value="Docente">Docente</option>
            <option value="Externo">Externo</option>
          </select>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Carrera:</label>
          <select id="filtroCarrera" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <option value="">Todas</option>
          </select>
        </div>
      </div>

      <button id="btnLimpiarFiltros" style="margin-top: 15px; padding: 8px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
        Limpiar Filtros
      </button>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
      <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 20px; border-radius: 8px; text-align: center;">
        <h3 style="margin: 0 0 5px 0; font-size: 32px; font-weight: bold;" id="total-inscripciones">0</h3>
        <p style="margin: 0; font-size: 14px; color: white;"><strong>Total Inscripciones</strong></p>
      </div>
      <div style="background: linear-gradient(135deg, #28a745, #1e7e34); color: white; padding: 20px; border-radius: 8px; text-align: center;">
        <h3 style="margin: 0 0 5px 0; font-size: 32px; font-weight: bold;" id="total-hombres">0</h3>
        <p style="margin: 0; font-size: 14px; color: white;"><strong>Hombres</strong></p>
      </div>
      <div style="background: linear-gradient(135deg, #dc3545, #bd2130); color: white; padding: 20px; border-radius: 8px; text-align: center;">
        <h3 style="margin: 0 0 5px 0; font-size: 32px; font-weight: bold;" id="total-mujeres">0</h3>
        <p style="margin: 0; font-size: 14px; color: white;"><strong>Mujeres</strong></p>
      </div>
      <div style="background: linear-gradient(135deg, #6c757d, #495057); color: white; padding: 20px; border-radius: 8px; text-align: center;">
        <h3 style="margin: 0 0 5px 0; font-size: 32px; font-weight: bold;" id="total-otros">0</h3>
        <p style="margin: 0; font-size: 14px; color: white;"><strong>Otros</strong></p>
      </div>
      <div style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; padding: 20px; border-radius: 8px; text-align: center;">
        <h3 style="margin: 0 0 5px 0; font-size: 32px; font-weight: bold;" id="mostrando">0</h3>
        <p style="margin: 0; font-size: 14px; color: white;"><strong>Mostrando</strong></p>
      </div>
    </div>

    <div class="tabla-container">
      <table id="tabla-inscripciones" class="admin-table">
        <thead>
          <tr>
            <th>Matrícula</th>
            <th>Nombre Completo</th>
            <th>Correo</th>
            <th>Género</th>
            <th>Tipo</th>
            <th>Carrera/Facultad</th>
            <th>Evento</th>
            <th>Fecha Inscripción</th>
          </tr>
        </thead>
        <tbody id="tbody-inscripciones">
          <tr>
            <td colspan="8" style="text-align: center; padding: 30px; color: #666;">
              Cargando inscripciones...
            </td>
          </tr>
        </tbody>
      </table>
    </div> 
    
    <div style="text-align: right; margin-top: 20px; margin-bottom: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button id="btnGenerarExcel" class="btn-reporte btn-excel">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            Exportar a Excel
        </button>
        
        <button id="btnGenerarPDF" class="btn-reporte btn-pdf">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
            </svg>
            Generar PDF
        </button>
    </div>
  </main>

  <script>
    let todasInscripciones = [];
    let inscripcionesFiltradas = [];

    // Verificar sesión y cargar datos
    window.addEventListener('DOMContentLoaded', () => {
      verificarSesion();
      cargarInscripciones();
      configurarFiltros();
    });

    function verificarSesion() {
      fetch('../../php/admin/verificarSesion.php')
        .then(response => response.json())
        .then(data => {
          if (!data.loggedin) {
            window.location.href = '../login.html';
          }
        });
    }

    function cargarInscripciones() {
      fetch('../../php/admin/verInscripciones.php')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            todasInscripciones = data.inscripciones;
            inscripcionesFiltradas = data.inscripciones;
            
            mostrarInscripciones(inscripcionesFiltradas);
            actualizarEstadisticas(data.estadisticas);
            poblarFiltroEventos();
          } else {
            document.getElementById('tbody-inscripciones').innerHTML = 
              '<tr><td colspan="8" style="text-align: center; padding: 30px; color: red;">Error al cargar inscripciones</td></tr>';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('tbody-inscripciones').innerHTML = 
            '<tr><td colspan="8" style="text-align: center; padding: 30px; color: red;">Error de conexión</td></tr>';
        });
    }

    // Filtro por Carrera
    function poblarFiltroCarreras() {
      const selectCarrera = document.getElementById('filtroCarrera');
      const carrerasUnicas = [...new Set(todasInscripciones.map(i => i.carrera_display || i.carrera_nombre).filter(c => c && c !== 'No especificada'))];
      
      selectCarrera.innerHTML = '<option value="">Todas</option>';
      carrerasUnicas.sort().forEach(carrera => {
        selectCarrera.innerHTML += `<option value="${carrera}">${carrera}</option>`;
      }); 
    }

    function poblarFiltroEventos() {
      const selectEvento = document.getElementById('filtroEvento');
      const eventosUnicos = [...new Set(todasInscripciones.map(i => i.evento_nombre))];
      
      selectEvento.innerHTML = '<option value="">Todos los eventos</option>';
      eventosUnicos.forEach(evento => {
        selectEvento.innerHTML += `<option value="${evento}">${evento}</option>`;
      });
      poblarFiltroCarreras(); 
    }

    function mostrarInscripciones(inscripciones) {
      const tbody = document.getElementById('tbody-inscripciones');
      
      if (inscripciones.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #666;">No hay inscripciones que coincidan con los filtros</td></tr>';
        document.getElementById('mostrando').textContent = '0';
        return;
      }

      tbody.innerHTML = '';
      
      inscripciones.forEach(insc => {
        const tr = document.createElement('tr');
        // Eliminamos los estilos en línea para que actúe el CSS (adminTablas.css)
        
        let carreraDisplay = insc.carrera_display || insc.carrera_nombre || 'No especificada';
        const facultadInfo = insc.facultad_siglas ? ` (${insc.facultad_siglas})` : '';
        
        // Usamos tags con estilos mínimos para los badges de tipo
        const badgeClass = 'tag-rol ' + insc.tipo_participante.toLowerCase(); // ej: tag-rol estudiante
        
        // NOTA: Eliminamos style="..." de los <td> para que adminTablas.css aplique el padding y border
        tr.innerHTML = `
          <td><strong>${insc.participante_matricula}</strong></td>
          <td>${insc.nombre_completo}</td>
          <td>${insc.correo_institucional}</td>
          <td>${insc.genero}</td>
          <td>
            <span class="${badgeClass}" style="padding: 4px 8px; border-radius: 15px; font-size: 12px; color: white; background-color: ${getTipoColor(insc.tipo_participante)}">
              ${insc.tipo_participante}
            </span>
          </td>
          <td>${carreraDisplay}${facultadInfo}</td>
          <td><strong>${insc.evento_nombre}</strong></td>
          <td>${formatearFechaHora(insc.fecha_inscripcion)}</td>
        `;
        tbody.appendChild(tr);
      });
      
      document.getElementById('mostrando').textContent = inscripciones.length;
    }

    function getTipoColor(tipo) {
      switch(tipo) {
        case 'Estudiante': return '#17a2b8';
        case 'Docente': return '#28a745';
        case 'Externo': return '#ffc107; color: #333;'; // Externo en amarillo
        default: return '#6c757d';
      }
    }

    function actualizarEstadisticas(stats) {
      document.getElementById('total-inscripciones').textContent = stats.total_inscripciones || 0;
      document.getElementById('total-hombres').textContent = stats.por_genero?.Hombre || 0;
      document.getElementById('total-mujeres').textContent = stats.por_genero?.Mujer || 0;
      document.getElementById('mostrando').textContent = stats.mostrando || 0;
      const totalOtros = stats.por_genero ? (stats.por_genero['Prefiero no decirlo'] || 0) : 0;
      document.getElementById('total-otros').textContent = totalOtros;
    }

    function formatearFechaHora(fecha) {
      if (!fecha) return 'N/A';
      const fechaObj = new Date(fecha);
      const opciones = { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      return fechaObj.toLocaleString('es-MX', opciones);
    }

    function configurarFiltros() {
      document.getElementById('buscarInscripcion').addEventListener('input', aplicarFiltros);
      document.getElementById('filtroEvento').addEventListener('change', aplicarFiltros);
      document.getElementById('filtroGenero').addEventListener('change', aplicarFiltros);
      document.getElementById('filtroTipo').addEventListener('change', aplicarFiltros);
      document.getElementById('filtroCarrera').addEventListener('change', aplicarFiltros);
      
      document.getElementById('btnLimpiarFiltros').addEventListener('click', () => {
        document.getElementById('buscarInscripcion').value = '';
        document.getElementById('filtroEvento').value = '';
        document.getElementById('filtroGenero').value = '';
        document.getElementById('filtroTipo').value = '';
        document.getElementById('filtroCarrera').value = '';
        aplicarFiltros();
      });
    }

    function aplicarFiltros() {
      const textoBusqueda = document.getElementById('buscarInscripcion').value.toLowerCase();
      const eventoFiltro = document.getElementById('filtroEvento').value;
      const generoFiltro = document.getElementById('filtroGenero').value;
      const tipoFiltro = document.getElementById('filtroTipo').value;
      const carreraFiltro = document.getElementById('filtroCarrera').value;
      
      inscripcionesFiltradas = todasInscripciones.filter(insc => {
        const coincideBusqueda = !textoBusqueda || 
          insc.nombre_completo.toLowerCase().includes(textoBusqueda) ||
          insc.participante_matricula.toLowerCase().includes(textoBusqueda) ||
          insc.correo_institucional.toLowerCase().includes(textoBusqueda) ||
          insc.evento_nombre.toLowerCase().includes(textoBusqueda);
        
        const coincideEvento = !eventoFiltro || insc.evento_nombre === eventoFiltro;
        const coincideGenero = !generoFiltro || insc.genero === generoFiltro;
        const coincideTipo = !tipoFiltro || insc.tipo_participante === tipoFiltro;
        
        const carreraParticipante = insc.carrera_display || insc.carrera_nombre || '';
        const coincideCarrera = !carreraFiltro || carreraParticipante === carreraFiltro;
        
        return coincideBusqueda && coincideEvento && coincideGenero && coincideTipo && coincideCarrera;
      });
      
      mostrarInscripciones(inscripcionesFiltradas);
      
      const statsLocales = {
        total_inscripciones: inscripcionesFiltradas.length,
        mostrando: inscripcionesFiltradas.length,
        por_genero: {
          Hombre: inscripcionesFiltradas.filter(i => i.genero === 'Hombre').length,
          Mujer: inscripcionesFiltradas.filter(i => i.genero === 'Mujer').length,
          'Prefiero no decirlo': inscripcionesFiltradas.filter(i => i.genero === 'Prefiero no decirlo').length
        }
      };
      actualizarEstadisticas(statsLocales);
    }

  </script>
  <script src="../js/headFooter.js"></script>
  <script src="../js/admin/generarReporte.js"></script>

</body>
</html>