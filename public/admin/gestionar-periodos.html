<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestionar Periodos - Admin</title>
  <link rel="stylesheet" href="../css/main.css">
  <style>
    .periodo-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .badge-activo { background: #28a745; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
    .badge-inactivo { background: #6c757d; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>
  
  <main class="page-content">
    <h1>Gestión de Periodos</h1>
    <p>Crea semestres y selecciona cual está activo. Solo los eventos del periodo activo serán visibles para los alumnos.</p>

    <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3 style="margin-top:0;">Crear Nuevo Periodo</h3>
        <form id="formCrearPeriodo" style="display: flex; gap: 10px;">
            <input type="text" id="nombrePeriodo" placeholder="Ej: 2025-2" required style="padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
            <button type="submit" style="background: #006633; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Crear</button>
        </form>
    </div>

    <h3>Lista de Periodos</h3>
    <div id="lista-periodos">Cargando...</div>
  </main>

  <script src="../js/headFooter.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', cargarPeriodos);

    function cargarPeriodos() {
        const lista = document.getElementById('lista-periodos');
        lista.innerHTML = '<p>Cargando datos...</p>';

        fetch('../../php/admin/gestionarPeriodos.php?accion=obtener')
            .then(response => {
                // Verificar si la respuesta de red es OK
                if (!response.ok) {
                    throw new Error('Error en la red o servidor: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log("Datos recibidos:", data); // Para depuración

                lista.innerHTML = ''; // Limpiar mensaje de carga

                // CORRECCIÓN: Verificar si data.periodos existe y es un array
                if (data.success && Array.isArray(data.periodos)) {
                    
                    if (data.periodos.length === 0) {
                        lista.innerHTML = '<p>No hay periodos registrados. Crea uno nuevo.</p>';
                        return;
                    }

                    data.periodos.forEach(p => {
                        // Estilos condicionales
                        const bordeStyle = p.activo ? 'border-left: 5px solid #28a745; background-color: #f0fff4;' : '';
                        const estadoHtml = p.activo 
                            ? '<span class="badge-activo" style="background:#28a745; color:white; padding:5px 10px; border-radius:15px;">ACTIVO ACTUALMENTE</span>' 
                            : `<button onclick="activarPeriodo(${p.id})" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Activar</button>`;

                        lista.innerHTML += `
                            <div class="periodo-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; ${bordeStyle}">
                                <div>
                                    <strong style="font-size: 1.2rem; color: #333;">${p.nombre}</strong>
                                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">ID: ${p.id}</div>
                                </div>
                                <div>${estadoHtml}</div>
                            </div>
                        `;
                    });
                } else {
                    // Si success es false o no hay array
                    console.error("Error lógico:", data);
                    lista.innerHTML = `<p style="color: red;">Error: ${data.mensaje || 'Respuesta inesperada del servidor'}</p>`;
                }
            })
            .catch(error => {
                console.error("Error Fetch:", error);
                lista.innerHTML = `<p style="color: red;">Error de conexión: ${error.message}</p>`;
            });
    }

    document.getElementById('formCrearPeriodo').addEventListener('submit', (e) => {
        e.preventDefault();
        const nombreInput = document.getElementById('nombrePeriodo');
        const nombre = nombreInput.value.trim();

        if(!nombre) return alert("Escribe un nombre");

        fetch('../../php/admin/gestionarPeriodos.php?accion=crear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre: nombre })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(data.mensaje);
                nombreInput.value = ''; // Limpiar input
                cargarPeriodos(); // Recargar lista
            } else {
                alert("Error: " + data.mensaje);
            }
        })
        .catch(e => alert("Error de conexión al crear"));
    });

    window.activarPeriodo = function(id) {
        if(!confirm('¿Seguro que quieres activar este periodo? Los alumnos dejarán de ver eventos de otros periodos.')) return;
        
        fetch('../../php/admin/gestionarPeriodos.php?accion=activar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // alert(data.mensaje); // Opcional
                cargarPeriodos();
            } else {
                alert("Error: " + data.mensaje);
            }
        })
        .catch(e => alert("Error de conexión al activar"));
    }
</script>
</body>
</html>